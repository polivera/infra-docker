services:
    mysql:
        image: mysql:8.0
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-}
        ports:
            - "3306:3306"
        volumes:
            - /mnt/fast/mysql:/var/lib/mysql
        networks:
            - mysql_network
        deploy:
            replicas: 1
            restart_policy:
                condition: on-failure
            resources:
                limits:
                    cpus: "1"
                    memory: 2G
                reservations:
                    cpus: "0.5"
                    memory: 512M

    mysql-cron-backup:
        image: mysql:8.0
        volumes:
            - /mnt/slow/backups/mysql:/backups
        environment:
            MYSQL_HOST: mysql
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            DATABASE_NAMES: "npmanager"
        networks:
            - mysql_network
        command: |
            sh -c "
            while true; do
              echo 'Starting backup at $$(date)'
              
              # Read comma-separated database names from env variable
              IFS=',' read -ra DB_ARRAY <<< \"$$DATABASE_NAMES\"
              
              # Loop through each database and create individual backups
              for db in \"\$${DB_ARRAY[@]}\"; do
                # Trim whitespace from database name
                db=\$$(echo \"$$db\" | xargs)
                
                if [ -n \"$$db\" ]; then
                  echo \"Backing up database: $$db\"
                  mysqldump -h mysql -u root -p$$MYSQL_ROOT_PASSWORD --single-transaction --routines --triggers \"$$db\" > \"/backups/backup-$$db-$$(date +%Y%m%d-%H%M%S).sql\"
                  echo \"Backup completed for: $$db\"
                fi
              done
              
              echo 'All backups completed'
              
              # Clean old backups (keep last 7 days)
              find /backups -name 'backup-*.sql' -mtime +7 -delete
              
              # Sleep for 24 hours (86400 seconds)
              sleep 86400
            done"
        deploy:
            replicas: 1
            restart_policy:
                condition: on-failure
            resources:
                limits:
                    cpus: "1"
                    memory: 2G
                reservations:
                    cpus: "0.5"
                    memory: 512M

# volumes:
#     mysql_data:
#         driver: local
#         driver_opts:
#             type: none
#             o: bind
#             device: "/mnt/fast/mysql"
#     mysql_backups:
#         driver: local
#         driver_opts:
#             type: local
#             o: bind
#             device: "/mnt/fast/backups/mysql"

networks:
    mysql_network:
        driver: overlay
        name: mysql_network
        internal: true
